USE ERP;

-- CARREGANDO DADOS NA TABELA EMPRESA
INSERT INTO EMPRESA VALUES
('MIX BIKES','MATRIZ'),('MIX BIKES','FILIAL');
-- VERIFICANDO DADOS
SELECT * FROM EMPRESA;

-- CARREGANDO DADOS NA TABELA PARAMETROS
INSERT INTO PARAMETROS VALUES
(1,'PED_COMPRAS',0),(1,'MATRICULA',0),(1,'PED_VENDAS',0),(1,'NOTA_FISCAL',0),
(2,'PED_COMPRAS',0),(2,'MATRICULA',0),(2,'PED_VENDAS',0),(2,'NOTA_FISCAL',0);
-- VERIFICANDO DADOS
SELECT* FROM PARAMETROS;

-- CARREGANDO DADOS NA TABELA UF
INSERT INTO UF VALUES
('SP','SÃO PAULO'),('RJ','RIO DE JANEIRO');
-- VERIFICANDO DADOS
SELECT * FROM UF;

-- CARREGANDO DADOS NA TABELA CIDADE
INSERT INTO CIDADE VALUES
('3550308','SP','SÃO PAULO'),('3304557','RJ','RIO DE JANEIRO');
-- VERIFICANDO DADOS
SELECT * FROM CIDADE;

-- CARREGANDO DADOS NA TABELA CLIENTES
INSERT INTO CLIENTES VALUES
(1,'CASA DAS BIKES LTDA','CASA DAS BIKES','AVENIDA PAULISTA','12','BELA VISTA','3550308','01310946','12345678910','J',GETDATE(),1),
(1,'CIRCUITO BIKES LTDA','CIRCUITO BIKES','AVENIDA PAULISTA','34','BELA VISTA','3550308','01310946','12345678910','J',GETDATE(),2),
(2,'TRILHA SÓBIKES LTDA','TRILHA SÓBIKES','AVENIDA DAS AMÉRICAS','12','BARRA DA TIJUCA','3304557','22640100','12345678910','F',GETDATE(),3),
(2,'BIKES FOR LIFE LTDA','BIKES FOR LIFE','AVENIDA DAS AMÉRICAS','34','BARRA DA TIJUCA','3304557','22640100','12345678910','F',GETDATE(),3);
-- VERIFICANDO DADOS
SELECT * FROM CLIENTES;

-- CARREGANDO DADOS NA TABELA FORNECEDORES
INSERT INTO  FORNECEDORES VALUES
(1,'NATIONAL BIKES LTDA','NATIONAL BIKES','AVENIDA PAULISTA','56','BELA VISTA','3550308','01310946','12345678910','J',GETDATE(),1),
(1,'ESPECIAL BIKES LTDA','ESPECIAL BIKES','AVENIDA PAULISTA','78','BELA VISTA','3550308','01310946','12345678910','J',GETDATE(),2),
(2,'SPORTING BIKES LTDA','SPORTING BIKES','AVENIDA DAS AMÉRICAS','56','BARRA DA TIJUCA','3304557','22640100','12345678910','J',GETDATE(),3),
(2,'TRACKING BIKES LTDA','TRACKING BIKES','AVENIDA DAS AMÉRICAS','78','BARRA DA TIJUCA','3304557','22640100','12345678910','J',GETDATE(),3);
-- VERIFICANDO DADOS
SELECT * FROM FORNECEDORES;

-- CARREGANDO DADOS NA TABELA TIPO DE MATERIAL
INSERT INTO TIPO_MAT VALUES
(1,1,'MATERIA PRIMA'),(1,2,'PRODUTO ACABADO'),(1,3,'EMBALAGEM'),(1,4,'CONSUMO'),
(2,1,'MATERIA PRIMA'),(2,2,'PRODUTO ACABADO'),(2,3,'EMBALAGEM'),(2,4,'CONSUMO');
-- VERIFICANDO DADOS
SELECT * FROM TIPO_MAT;

-- CARREGANDO DADOS NA TABELA MATERIAL
INSERT INTO MATERIAL VALUES
(1,1,'BICICLETA ARO 29 PRETA MOD INFINITY','2500','2',''),
(1,2,'BICICLETA ARO 29 BRANCA MOD INFINITY','2500','2',''),
(1,3,'QUADRO ARO 29','500','1','1'),
(1,4,'KIT TRANSMISSÃO','500','1','1'),
(1,5,'ARO 29','70','1','1'),
(1,6,'PNEU 29','100','1','2'),
(1,7,'CÂMARA 29','25','1','2'),
(1,8,'SUSPENSÃO DIANTEIRA','250','1','2'),
(1,9,'BANCO','80','1','3'),
(1,10,'CANOTE','35','1','3'),
(1,11,'TINTA BRANCA','10','4','2'),
(1,12,'TINTA PRETA','10','4','2'),
(1,13,'MESA','500','1','1'),
(1,14,'GUIDON','50','1','2'),
(1,15,'LUVAS','30','1','2'),
(1,16,'CAIXA EMBALAGEM','10','3','2');
-- VERIFICANDO DADOS
SELECT * FROM MATERIAL;

-- CARREGANDO DADOS NA TABELA FICHA TÉCNICA BIKE PRETA
INSERT INTO FICHA_TECNICA VALUES
(1,'1','3',1),(1,'1','4',1),(1,'1','5',2),(1,'1','6',2),(1,'1','7',2),
(1,'1','8',1),(1,'1','9',1),(1,'1','10',1),(1,'1','12',0.250),
(1,'1','13',1),(1,'1','14',1),(1,'1','15',2),(1,'1','16',1);
-- CARREGANDO DADOS NA TABELA FICHA TÉCNICA BIKE BRANCA
INSERT INTO FICHA_TECNICA VALUES
(1,'2','3',1),(1,'2','4',1),(1,'2','5',2),(1,'2','6',2),(1,'2','7',2),
(1,'2','8',1),(1,'2','9',1),(1,'2','10',1),(1,'2','11',0.250),
(1,'2','13',1),(1,'2','14',1),(1,'2','15',2),(1,'2','16',1);
-- VERIFICANDO DADOS
SELECT * FROM FICHA_TECNICA;

-- CARREGANDO DADOS NA TABELA CENTRO DE CUSTO
INSERT INTO CENTRO_CUSTO VALUES
(1,'9001','PRESIDÊNCIA'),
(1,'9002','ADMINISTRATIVO'),
(1,'9003','PRODUÇÃO'),
(1,'9004','SUPRIMENTOS'),
(1,'9005','RH'),
(1,'9006','FINANCEIRO'),
(1,'9007','COMERCIAL'),
(1,'9008','FISCAL'),
(1,'9009','TI'),
(2,'9001','PRESIDÊNCIA'),
(2,'9002','ADMINISTRATIVO'),
(2,'9003','PRODUÇÃO'),
(2,'9004','SUPRIMENTOS'),
(2,'9005','RH'),
(2,'9006','FINANCEIRO'),
(2,'9007','COMERCIAL'),
(2,'9008','FISCAL'),
(2,'9009','TI');
-- VERIFICANDO DADOS
SELECT * FROM CENTRO_CUSTO;

-- CARREGANDO DADOS NA TABELA CARGOS EMPRESA 1
INSERT INTO CARGOS VALUES
(1,'PRESIDENTE'),
(1,'GER COMERCIAL'),
(1,'VENDEDOR'),
(1,'GER ADM'),
(1,'ASSISTENTE DE RH'),
(1,'OPERADOR PRODUCAO'),
(1,'ESTOQUISTA'),
(1,'ANALISTA DE SISTEMA'),
(1,'FATURISTA'),
(1,'ASSISTENTE FINANCEIRO');
-- VERIFICANDO DADOS
SELECT * FROM CARGOS;
-- CARREGANDO DADOS NA TABELA CARGOS EMPRESA 2
SET IDENTITY_INSERT CARGOS ON -- DESABILITANDO IDENTITY
INSERT INTO CARGOS (COD_EMPRESA, COD_CARGO, NOME_CARGO)
SELECT 2, COD_CARGO, NOME_CARGO FROM CARGOS
SET IDENTITY_INSERT CARGOS OFF; -- HABILITANDO IDENTITY
-- VERIFICANDO DADOS
SELECT * FROM CARGOS;


-- CRIANDO TRIGGER PARA NUMERAÇÃO DE MATRÍCULAS
CREATE TRIGGER TG_NUM_MATR ON FUNCIONARIO
	INSTEAD OF INSERT AS
		BEGIN
			DECLARE @PARAM VARCHAR(50), @MATRICULA INT, @COD_EMPRESA INT
			SET @PARAM = 'MATRICULA'
			SELECT @MATRICULA = MATRICULA, @COD_EMPRESA = COD_EMPRESA
			FROM INSERTED
			IF @MATRICULA = 0
			BEGIN
				SELECT @MATRICULA = VALOR + 1 FROM PARAMETROS
				WHERE PARAM = @PARAM
				AND COD_EMPRESA = @COD_EMPRESA
				INSERT INTO FUNCIONARIO
				SELECT COD_EMPRESA, @MATRICULA, COD_CC, NOME, RG, CPF, ENDERECO,
				NUMERO, BAIRRO, COD_CIDADE, DATA_ADMISS, DATE_DEMISS, DATA_NASC,
				TELEFONE, COD_CARGO
				FROM INSERTED
				WHERE 1 = 1
				UPDATE PARAMETROS SET VALOR = VALOR + 1
				WHERE PARAM = @PARAM
				AND COD_EMPRESA = @COD_EMPRESA
			END
		END;

-- CARREGANDO DADOS NA TABELA FUNCIONARIO
INSERT INTO FUNCIONARIO VALUES
(1,0,'9001','AMANDA','1234567','123456789','RUA DO SOL','11','PRIMAVERA','3550308','2020-01-01','','1980-12-01','','1'),
(1,0,'9002','SORAIA','1234567','123456789','RUA DO SOL','12','PRIMAVERA','3550308','2020-02-01','','1980-11-01','','4'),
(1,0,'9003','BRENNA','1234567','123456789','RUA DO SOL','13','PRIMAVERA','3550308','2020-03-01','','1980-10-01','','6'),
(1,0,'9004','SANDRA','1234567','123456789','RUA DO SOL','14','PRIMAVERA','3550308','2020-04-01','','1980-09-01','','7'),
(1,0,'9005','FATIMA','1234567','123456789','RUA DO SOL','15','PRIMAVERA','3550308','2020-05-01','','1980-08-01','','5'),
(1,0,'9006','LILIAN','1234567','123456789','RUA DO SOL','16','PRIMAVERA','3550308','2020-06-01','','1980-07-01','','1'),
(1,0,'9007','PAOLLA','1234567','123456789','RUA DO SOL','17','PRIMAVERA','3550308','2020-07-01','','1980-06-01','','2'),
(1,0,'9007','MALCON','1234567','123456789','RUA DO SOL','18','PRIMAVERA','3550308','2020-08-01','','1980-05-01','','3'),
(1,0,'9007','WESLEY','1234567','123456789','RUA DO SOL','19','PRIMAVERA','3550308','2020-09-01','','1980-04-01','','3'),
(1,0,'9008','RAFAEL','1234567','123456789','RUA DO SOL','20','PRIMAVERA','3550308','2020-10-01','','1980-03-01','','9'),
(1,0,'9009','DANILO','1234567','123456789','RUA DO SOL','21','PRIMAVERA','3550308','2020-11-01','','1980-02-01','','8'),
(1,0,'9002','SAMUEL','1234567','123456789','RUA DO SOL','22','PRIMAVERA','3550308','2020-12-01','','1980-01-01','','10');
-- VERIFICANDO DADOS
SELECT * FROM FUNCIONARIO;

-- CARREGANDO DADOS NA TABELA USUARIOS
INSERT INTO USUARIOS (COD_EMPRESA, LOGIN, MATRICULA, SENHA, SITUACAO) VALUES
(1,'AMANDA','1','','A'),
(1,'SORAIA','2','','A'),
(1,'BRENNA','3','','A'),
(1,'SANDRA','4','','A'),
(1,'FATIMA','5','','A'),
(1,'LILIAN','6','','A'),
(1,'PAOLLA','7','','A'),
(1,'MALCON','8','','A'),
(1,'WESLEY','9','','A'),
(1,'RAFAEL','10','','A'),
(1,'DANILO','11','','A'),
(1,'SAMUEL','12','','A');
-- VERIFICANDO DADOS
SELECT * FROM USUARIOS;

-- GRAVANDO E CRIPTOGRAFANDO SENHA COM MD5 COM SENHA INICIAL = MATRICULA
UPDATE USUARIOS 
SET SENHA = CONVERT(VARCHAR(32), HASHBYTES('MD5', CONVERT(VARCHAR, MATRICULA)), 2);

-- CARREGANDO DADOS NA TABELA COND_PAGTO
INSERT INTO COND_PAGTO VALUES
('A VISTA'),
('3 X 30/60/90 DD'),
('30 DD');
-- VERIFICANDO DADOS
SELECT * FROM COND_PAGTO;

-- CARREGANDO DADOS NA TABELA COND_PAGTO_DET
INSERT INTO COND_PAGTO_DET VALUES
('1','1',0,100),
('2','1',30,33.34),
('2','2',60,33.33),
('2','3',90,33.33),
('3','1',30,100);
-- VERIFICANDO DADOS
SELECT * FROM COND_PAGTO_DET;

-- CARREGANDO DADOS NA TABELA VENDEDORES
INSERT INTO VENDEDORES
SELECT A.COD_EMPRESA, A.MATRICULA
FROM FUNCIONARIO A
	INNER JOIN CARGOS B
	ON A.COD_EMPRESA = B.COD_EMPRESA
	AND A.COD_CARGO = B.COD_CARGO
WHERE B.NOME_CARGO = 'VENDEDOR'
AND CONCAT(A.COD_EMPRESA, A.MATRICULA) NOT IN (SELECT CONCAT(COD_EMPRESA, MATRICULA) FROM VENDEDORES);
-- VERIFICANDO DADOS
SELECT * FROM VENDEDORES;

-- CARREGANDO DADOS NA TABELA GERENTES
INSERT INTO GERENTES
SELECT A.COD_EMPRESA,A.MATRICULA
FROM FUNCIONARIO A
	INNER JOIN CARGOS B
	ON A.COD_EMPRESA = B.COD_EMPRESA
	AND A.COD_CARGO = B.COD_CARGO
WHERE B.NOME_CARGO = 'GER COMERCIAL'
AND  CONCAT(A.COD_EMPRESA, A.MATRICULA) NOT IN (SELECT CONCAT(COD_EMPRESA, MATRICULA) FROM GERENTES);
-- VERIFICANDO DADOS
SELECT * FROM GERENTES;

-- CARREGANDO DADOS NA TABELA CANAL_VENDAS_G_V
INSERT INTO CANAL_VENDAS_G_V VALUES
(1,7,8),(1,7,9);
-- VERIFICANDO DADOS
SELECT * FROM CANAL_VENDAS_G_V;

-- CARREGANDO DADOS NA TABELA CANAL_VENDAS_V_C
INSERT CANAL_VENDAS_V_C VALUES
(1,8,1),(1,9,2);
-- VERIFICANDO DADOS
SELECT * FROM CANAL_VENDAS_V_C;

-- CARREGANDO DADOS NA TABELA META_VENDAS
INSERT INTO META_VENDAS VALUES
(1,9,'2018','01',83.33),(1,9,'2018','02',83.33),(1,9,'2018','03',83.33),(1,9,'2018','04',83.33),
(1,9,'2018','05',83.33),(1,9,'2018','06',83.33),(1,9,'2018','07',83.33),(1,9,'2018','08',83.33),
(1,9,'2018','09',83.33),(1,9,'2018','10',83.33),(1,9,'2018','11',83.33),(1,9,'2018','12',83.33),
(1,8,'2018','01',83.33),(1,8,'2018','02',83.33),(1,8,'2018','03',83.33),(1,8,'2018','04',83.33),
(1,8,'2018','05',83.33),(1,8,'2018','06',83.33),(1,8,'2018','07',83.33),(1,8,'2018','08',83.33),
(1,8,'2018','09',83.33),(1,8,'2018','10',83.33),(1,8,'2018','11',83.33),(1,8,'2018','12',83.33);
-- VERIFICANDO DADOS
SELECT * FROM META_VENDAS;

-- CARREGANDO DADOS NA TABELA CFOP
INSERT INTO CFOP VALUES
('5.101','VENDAS DE MERC'),('1.101','COMPRAS DE MERC');
-- VERIFICANDO DADOS
SELECT * FROM CFOP;

-- CRIANDO TRIGGER PARA NUMERAÇÃO DE PED_VENDAS
CREATE TRIGGER TG_NUM_PED_V ON PED_VENDAS
	INSTEAD OF INSERT AS
		BEGIN
			DECLARE @PARAM VARCHAR(50), @NUM_PEDIDO INT, @COD_EMPRESA INT
			SET @PARAM= 'PED_VENDAS'
			SELECT @NUM_PEDIDO = NUM_PEDIDO, @COD_EMPRESA = COD_EMPRESA
			FROM INSERTED
			IF @NUM_PEDIDO IS NULL
			BEGIN
				SELECT @NUM_PEDIDO = VALOR + 1 FROM PARAMETROS
				WHERE PARAM = @PARAM
				AND COD_EMPRESA = @COD_EMPRESA
				INSERT INTO PED_VENDAS
				SELECT COD_EMPRESA, @NUM_PEDIDO, ID_CLIENTE, COD_PAGTO,
				DATA_PEDIDO, DATA_ENTREGA, SITUACAO, 0
				FROM INSERTED
				WHERE 1 = 1
				UPDATE PARAMETROS SET VALOR = VALOR + 1
				WHERE PARAM = @PARAM
				AND COD_EMPRESA = @COD_EMPRESA
			END
		END;

-- CARREGANDO DADOS NA TABELA PED_VENDAS
INSERT INTO PED_VENDAS (COD_EMPRESA, ID_CLIENTE, COD_PAGTO, DATA_PEDIDO, DATA_ENTREGA, SITUACAO) VALUES
(1,1,1,'2018-01-13','2018-01-29','A'),
(1,2,3,'2018-02-13','2018-02-28','A'),
(1,1,2,'2018-03-13','2018-03-29','A'),
(1,2,2,'2018-04-13','2018-04-29','A'),
(1,2,3,'2018-05-13','2018-05-29','A'),
(1,1,3,'2018-06-13','2018-06-29','A'),
(1,2,1,'2018-07-13','2018-07-29','A'),
(1,1,3,'2018-08-13','2018-08-29','A'),
(1,2,2,'2018-09-13','2018-09-29','A'),
(1,2,1,'2018-10-13','2018-10-29','A'),
(1,1,2,'2018-11-13','2018-11-29','A'),
(1,2,2,'2018-12-13','2018-12-29','A');
-- VERIFICANDO DADOS
SELECT * FROM PED_VENDAS;

-- CARREGANDO DADOS NA TABELA PED_VENDAS_ITENS
INSERT INTO PED_VENDAS_ITENS VALUES
(1,1,1,1,35,2500),(1,1,2,2,40,2500),(1,2,1,1,50,2500),(1,2,2,2,35,2500),(1,3,1,1,50,2500),(1,3,2,2,35,2500),
(1,4,1,1,50,2500),(1,4,2,2,35,2500),(1,5,1,1,50,2500),(1,5,2,2,35,2500),(1,6,1,1,50,2500),(1,6,2,2,35,2500),
(1,7,1,1,50,2500),(1,7,2,2,35,2500),(1,8,1,1,70,2500),(1,8,2,2,70,2500),(1,9,1,1,50,2500),(1,9,2,2,35,2500),
(1,10,1,1,50,2500),(1,10,2,2,35,2500),(1,11,1,1,100,2500),(1,11,2,2,100,2500),(1,12,1,1,50,2500),(1,12,2,2,35,2500);
-- VERIFICANDO DADOS
SELECT * FROM PED_VENDAS_ITENS;

-- ATUALIZANDO TOTAL PED_VENDAS COM BASE NA TABELA PED_VENDAS_ITENS
WITH PED_ITENS(COD_EMPRESA, NUM_PEDIDO, TOTAL) AS
	(
	SELECT A.COD_EMPRESA, A.NUM_PEDIDO, SUM(A.QTD * A.VAL_UNIT) TOTAL
	FROM PED_VENDAS_ITENS A
	GROUP BY A.COD_EMPRESA, A.NUM_PEDIDO
	)
UPDATE PED_VENDAS SET TOTAL_PED = B.TOTAL
FROM PED_VENDAS A
	INNER JOIN PED_ITENS B
	ON A.NUM_PEDIDO = B.NUM_PEDIDO
	AND A.COD_EMPRESA = B.COD_EMPRESA;

-- CARREGANDO DADOS NA TABELA SALARIO
INSERT INTO SALARIO VALUES
(1,1,7650),(1,2,2650),(1,3,2550),(1,4,1550),(1,5,4550),(1,6,2850),
(1,7,1850),(1,8,1560),(1,9,3899),(1,10,2345),(1,11,3100),(1,12,4500);
-- VERIFICANDO DADOS
SELECT * FROM SALARIO;
						  
-- CARREGANDO DADOS NA TABELA PARAM_INSS
INSERT INTO PARAM_INSS VALUES
('2020-01-01','2020-12-31',0,1659.38,8),
('2020-01-01','2020-12-31',1659.39,2765.66,9),
('2020-01-01','2020-12-31',2765.67,5531.31,11),
('2020-01-01','2020-12-31',5531.32,999999,0);

-- CARREGANDO DADOS NA TABELA PARAM_IRRF
 INSERT INTO PARAM_IRRF VALUES
('2020-01-01','2020-12-31',0,1903.98,0,0),
('2020-01-01','2020-12-31',1903.99,2826.65,7.5,142.80),
('2020-01-01','2020-12-31',2826.66,3751.05,15,354.80),
('2020-01-01','2020-12-31',3751.06,4664.68,22.5,636.13),
('2020-01-01','2020-12-31',4664.68,999999,27.5,869.36);